# Copyright 2025 the Kubeapps contributors.
# SPDX-License-Identifier: Apache-2.0

---
name: Generate Helm Repository Index

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Index mode (stable or dev)'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - dev
      full_regen:
        description: 'Full regeneration (true to rebuild entire index)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      version:
        description: 'Single version/tag to process (optional, leave empty for all)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  generate_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full history for tags

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v4.0.0'

      - name: Generate Helm repository index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FULL_REGEN: ${{ inputs.full_regen }}
          INPUT_VERSION: ${{ inputs.version }}
          DEBUG: 'false'
        run: |
          set -eu
          MODE="${{ inputs.mode }}"
          echo "Generating Helm repository index in ${MODE} mode..."
          echo "Full regeneration: ${FULL_REGEN}"
          if [[ -n "${INPUT_VERSION}" ]]; then
            echo "Processing single version: ${INPUT_VERSION}"
          fi

          bash script/helm_index_publish.sh --mode="${MODE}"

      - name: Display index summary
        run: |
          if [[ -f index.yaml ]]; then
            echo "Generated index.yaml summary:"
            echo "---"
            yq eval '.entries | to_entries | .[] | .key + ": " + (.value | length | tostring) + " version(s)"' index.yaml
            echo "---"
            echo "Total entries: $(yq eval '.entries | length' index.yaml)"
          else
            echo "No index.yaml file found"
          fi
