# Copyright 2022-2024 the Kubeapps contributors.
# SPDX-License-Identifier: Apache-2.0

---
name: Helm Index Publisher

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Only package this specific chart version (optional)"
        required: false
        type: string
      full_regeneration:
        description: "Rebuild index.yaml from scratch and repackage all versions"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish_index:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      INPUT_VERSION: ${{ inputs.version }}
      FULL_REGEN: ${{ inputs.full_regeneration }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Helm
        run: |
          set -eu
          source ./script/lib/libcitools.sh
          installHelm ${HELM_VERSION_STABLE:-v4.0.0} helm-stable

      - name: Configure git identity (bot)
        run: |
          set -eu
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Publish stable helm index via script
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_VERSION: ${{ inputs.version }}
          FULL_REGEN: ${{ inputs.full_regeneration }}
        run: |
          set -eu
          bash script/helm_index_publish.sh --mode stable

      - name: Show Helm repo add instructions
        run: |
          echo "Users can run:"
          echo "  helm repo add kubeapps https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}/helm"
          echo "  helm repo update"
