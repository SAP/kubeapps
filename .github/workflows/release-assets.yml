# Copyright 2025 the Kubeapps contributors.
# SPDX-License-Identifier: Apache-2.0

name: Release assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag/version to test (e.g., v2.0.0-test)'
        required: true
        type: string
        default: 'v0.0.0-test'
      create_release:
        description: 'Create test release (or just generate asset)'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build_release_asset:
    runs-on: ubuntu-latest
    steps:
      - name: Determine tag and mode
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual test mode - use tag as-is for Helm compatibility
            TAG="${{ inputs.tag }}"
            CREATE_RELEASE="${{ inputs.create_release }}"
            
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "create_release=${CREATE_RELEASE}" >> "$GITHUB_OUTPUT"
            echo "is_test=true" >> "$GITHUB_OUTPUT"
            echo "ref=main" >> "$GITHUB_OUTPUT"
            
            echo "::notice::Test mode - Tag: ${TAG}, Create Release: ${CREATE_RELEASE}"
          else
            # Automatic release mode
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "create_release=true" >> "$GITHUB_OUTPUT"
            echo "is_test=false" >> "$GITHUB_OUTPUT"
            echo "ref=${GITHUB_REF}" >> "$GITHUB_OUTPUT"
            
            echo "::notice::Release mode - Tag: ${GITHUB_REF_NAME}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.config.outputs.ref }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v4.0.0'

      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || {
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          }

      - name: Build release asset
        id: build
        env:
          TAG: ${{ steps.config.outputs.tag }}
        run: |
          set -eu
          echo "Building release asset for tag: ${TAG}"
          ASSET_PATH=$(bash script/prepare_release_asset.sh "${TAG}")
          echo "asset_path=${ASSET_PATH}" >> "$GITHUB_OUTPUT"
          echo "::notice::Asset created: ${ASSET_PATH}"
          ls -lh "${ASSET_PATH}"

      - name: Create or update release
        if: steps.config.outputs.create_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          TAG="${{ steps.config.outputs.tag }}"
          KUBEAPPS_REPO="${GITHUB_REPOSITORY}"
          ASSET_PATH="${{ steps.build.outputs.asset_path }}"
          IS_TEST="${{ steps.config.outputs.is_test }}"
          
          # Create or update release
          bash script/create_release.sh "${TAG}" "${KUBEAPPS_REPO}"
          
          if [[ "${IS_TEST}" == "true" ]]; then
            echo "::warning::Test release created: ${TAG}. Remember to delete this test release when done!"
          fi

      - name: Upload artifact (test mode without release)
        if: steps.config.outputs.create_release == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.config.outputs.tag }}
          path: ${{ steps.build.outputs.asset_path }}
          retention-days: 7

      - name: Summary
        run: |
          echo "## Release Asset Build Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.config.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset**: ${{ steps.build.outputs.asset_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Mode**: ${{ steps.config.outputs.is_test }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Created**: ${{ steps.config.outputs.create_release }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.config.outputs.create_release }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.config.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          fi

