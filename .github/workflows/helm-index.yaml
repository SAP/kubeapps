# Copyright 2025 the Kubeapps contributors.
# SPDX-License-Identifier: Apache-2.0

---
name: Helm Index Publisher

on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag that was just released'
        required: false
        type: string
        default: ''
      mode:
        description: 'Index mode (stable, dev, or both)'
        required: false
        type: string
        default: 'auto'
      full_regeneration:
        description: 'Rebuild index from scratch'
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      mode:
        description: 'Index mode'
        required: true
        type: choice
        default: 'both'
        options:
          - stable
          - dev
          - both
      version:
        description: 'Single version/tag to process (optional, leave empty for all)'
        required: false
        type: string
        default: ''
      full_regeneration:
        description: 'Rebuild index from scratch'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # Determine which mode to run based on tag or input
  determine_mode:
    runs-on: ubuntu-latest
    outputs:
      run_stable: ${{ steps.decide.outputs.run_stable }}
      run_dev: ${{ steps.decide.outputs.run_dev }}
      version: ${{ steps.decide.outputs.version }}
    steps:
      - name: Decide which indexes to generate
        id: decide
        run: |
          set -eu

          EVENT_NAME="${{ github.event_name }}"
          echo "Event name: ${EVENT_NAME}"
          echo "Debug - inputs.tag: ${{ inputs.tag }}"
          echo "Debug - inputs.version: ${{ inputs.version }}"
          echo "Debug - inputs.mode: ${{ inputs.mode }}"

          # Determine tag and mode from inputs
          # workflow_call passes 'tag' and 'mode'
          # workflow_dispatch passes 'version' (for tag) and 'mode'

          if [[ -n "${{ inputs.tag }}" ]]; then
            # Called from another workflow (workflow_call) or has tag input
            TAG="${{ inputs.tag }}"
            MODE="${{ inputs.mode }}"
            echo "Using tag input: ${TAG}, mode: ${MODE}"
          elif [[ -n "${{ inputs.version }}" ]]; then
            # Manual workflow_dispatch with version
            TAG="${{ inputs.version }}"
            MODE="${{ inputs.mode }}"
            echo "Using version input: ${TAG}, mode: ${MODE}"
          else
            # Fallback
            TAG=""
            MODE="${{ inputs.mode }}"
            echo "No tag/version provided, mode: ${MODE}"
          fi

          # Auto-detect mode based on tag if mode is 'auto'
          if [[ "${MODE}" == "auto" ]]; then
            echo "Auto-detecting mode from tag: ${TAG}"
            if [[ "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "run_stable=true" >> "$GITHUB_OUTPUT"
              echo "run_dev=false" >> "$GITHUB_OUTPUT"
              echo "version=${TAG}" >> "$GITHUB_OUTPUT"
              echo "✓ Auto-detected: stable release (${TAG})"
              echo "✓ Outputs: run_stable=true, run_dev=false, version=${TAG}"
            elif [[ "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+- ]]; then
              echo "run_stable=false" >> "$GITHUB_OUTPUT"
              echo "run_dev=true" >> "$GITHUB_OUTPUT"
              echo "version=${TAG}" >> "$GITHUB_OUTPUT"
              echo "✓ Auto-detected: dev release (${TAG})"
              echo "✓ Outputs: run_stable=false, run_dev=true, version=${TAG}"
            else
              echo "run_stable=false" >> "$GITHUB_OUTPUT"
              echo "run_dev=false" >> "$GITHUB_OUTPUT"
              echo "version=${TAG}" >> "$GITHUB_OUTPUT"
              echo "⚠ Tag ${TAG} doesn't match stable or dev pattern"
              echo "⚠ Outputs: run_stable=false, run_dev=false, version=${TAG}"
            fi
          elif [[ "${MODE}" == "both" ]]; then
            echo "run_stable=true" >> "$GITHUB_OUTPUT"
            echo "run_dev=true" >> "$GITHUB_OUTPUT"
            echo "version=${TAG}" >> "$GITHUB_OUTPUT"
            echo "✓ Mode: both (generating stable and dev indexes)"
            echo "✓ Outputs: run_stable=true, run_dev=true, version=${TAG}"
          elif [[ "${MODE}" == "stable" ]]; then
            echo "run_stable=true" >> "$GITHUB_OUTPUT"
            echo "run_dev=false" >> "$GITHUB_OUTPUT"
            echo "version=${TAG}" >> "$GITHUB_OUTPUT"
            echo "✓ Mode: stable only"
            echo "✓ Outputs: run_stable=true, run_dev=false, version=${TAG}"
          elif [[ "${MODE}" == "dev" ]]; then
            echo "run_stable=false" >> "$GITHUB_OUTPUT"
            echo "run_dev=true" >> "$GITHUB_OUTPUT"
            echo "version=${TAG}" >> "$GITHUB_OUTPUT"
            echo "✓ Mode: dev only"
            echo "✓ Outputs: run_stable=false, run_dev=true, version=${TAG}"
          fi

  # Generate stable index
  generate_stable_index:
    needs: determine_mode
    if: needs.determine_mode.outputs.run_stable == 'true'
    uses: ./.github/workflows/helm-index-generator.yml
    with:
      mode: 'stable'
      version: ${{ needs.determine_mode.outputs.version }}
      full_regeneration: ${{ inputs.full_regeneration || false }}
    secrets: inherit

  # Generate dev index
  generate_dev_index:
    needs: determine_mode
    if: needs.determine_mode.outputs.run_dev == 'true'
    uses: ./.github/workflows/helm-index-generator.yml
    with:
      mode: 'dev'
      version: ${{ needs.determine_mode.outputs.version }}
      full_regeneration: ${{ inputs.full_regeneration || false }}
    secrets: inherit
